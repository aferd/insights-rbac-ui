import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Documentation/Architecture" />

# Architecture

Architectural decisions and design principles for the RBAC UI. This doc covers the *why* behind structural choices, not the file tree (which lives as `README.md` files co-located with each feature).

---

## What This App Is

A React application embedded in the Red Hat Console platform (`@redhat-cloud-services/insights-chrome`). It manages Role-Based Access Control across two generations of the RBAC API:

- **v1** — the original RBAC platform (groups, roles, users, policies, permissions). Accessed via `@redhat-cloud-services/rbac-client`. Types are broken — see [API Client Patterns](?path=/docs/documentation-patterns-api-client-patterns--docs).
- **v2** — the workspaces-based access management model. Accessed via `@redhat-cloud-services/rbac-client/v2`. Types work correctly.

Both APIs will coexist for the foreseeable future. The E2E test suite runs separate V1 and V2 test tracks. See [E2E Testing Strategy](?path=/docs/documentation-e2e-testing-strategy--docs) for details on how the two tracks work.

---

## Feature Islands

Features are self-contained islands under `src/features/`, organized by business domain. Each island owns its components, hooks, and local state. Shared infrastructure lives in `src/components/` and `src/data/`.

**The rule:** only move something to `src/components/` when it is genuinely reusable across multiple unrelated features, domain-agnostic, and stable. Premature extraction creates accidental coupling.

Each feature directory should have a `README.md` explaining what that island is responsible for, what APIs it calls, and any non-obvious constraints.

---

## Data Layer

Three layers, strict separation:

```
src/data/api/       ← thin API wrappers, no React, no state
src/data/queries/   ← TanStack Query hooks (useXxxQuery, useXxxMutation)
src/features/       ← components consume hooks, no direct API calls
```

Components never call the API directly. They import from `src/data/queries/`. See [Redux to TanStack Query](?path=/docs/documentation-architecture-redux-to-tanstack-query--docs) for the full data layer reference and the Query Keys Factory pattern.

---

## Module Federation

The app exposes federated modules for consumption by other Red Hat Console applications (e.g. the workspace selector used by other services). Exposed entry points live in `src/federated-modules/`. Each one needs a Storybook story for isolated development and testing.

The federation config is in `fec.config.js`.

---

## Permissions and Environment

The permissions model differs between the two API generations.

**v1 (User Access — groups, roles, users):** coarse-grained. `orgAdmin` (boolean) gates all mutations. `isProd()` from `useChrome()` disables destructive actions in production. Both are injected via the Chrome API and mocked in Storybook via webpack aliases — see [Permissions & Context Testing](?path=/docs/documentation-permissions-context-testing--docs).

**v2 (Access Management — workspaces):** per-resource Kessel access checks via `@project-kessel/react-kessel-access-check`. Six relations per workspace: `view`, `edit`, `delete`, `create`, `move`, `rename`. The abstraction lives in `src/features/workspaces/hooks/useWorkspacePermissions.ts` and its composite `useWorkspacesWithPermissions`. Currently wired in `ManagedWorkspaceSelector` — that component is the reference implementation. `orgAdmin` does not apply here.

When writing permission checks, identify which API generation the feature belongs to before reaching for `orgAdmin`.

---

## Testing Philosophy

Two tracks, different purposes:

- **Storybook + MSW** — fast, deterministic, developer-focused. Every component state, every edge case. Required for all new components and features.
- **Playwright + CLI** — real API, real staging database, production confidence. Required for critical user journeys once they're stable in Storybook.

The workflow is: build in Storybook → add play functions → graduate to Playwright. See [E2E Testing Strategy](?path=/docs/documentation-e2e-testing-strategy--docs).

---

## Related Docs

| Topic | Doc |
|-------|-----|
| Table component and state management | [TableView](?path=/docs/documentation-tableview--docs) |
| Data fetching patterns and React Query | [Redux to TanStack Query](?path=/docs/documentation-architecture-redux-to-tanstack-query--docs) |
| API client quirks (broken types) | [API Client Patterns](?path=/docs/documentation-patterns-api-client-patterns--docs) |
| E2E testing and V1/V2 test tracks | [E2E Testing Strategy](?path=/docs/documentation-e2e-testing-strategy--docs) |
| Storybook rules (non-negotiable) | [Storybook Mandatory Rules](?path=/docs/documentation-storybookmandatoryrules--docs) |
| PatternFly imports, icons, i18n | [PatternFly Patterns](?path=/docs/documentation-patternfly-patterns--docs) |
